<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ chapter_title }}</title>
    <link rel="stylesheet" href="../../../static/style.css">
    
    <!-- SEO Meta Tags -->
    {% if seo_meta_description %}
    <meta name="description" content="{{ seo_meta_description }}">
    {% endif %}
    {% if seo_keywords %}
    <meta name="keywords" content="{{ seo_keywords }}">
    {% endif %}
    {% if not allow_indexing %}
    <meta name="robots" content="noindex, nofollow">
    {% endif %}
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="{{ social_title }}">
    <meta property="og:description" content="{{ social_description }}">
    <meta property="og:image" content="{{ social_image }}">
    <meta property="og:url" content="{{ social_url }}">
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="{{ site_name }}">
    {% if chapter_metadata.published %}
    <meta property="article:published_time" content="{{ chapter_metadata.published }}">
    {% endif %}
    {% if chapter_metadata.author %}
    <meta property="article:author" content="{{ chapter_metadata.author }}">
    {% endif %}
    {% if chapter_metadata.tags %}
    {% for tag in chapter_metadata.tags %}
    <meta property="article:tag" content="{{ tag }}">
    {% endfor %}
    {% endif %}
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ social_title }}">
    <meta name="twitter:description" content="{{ social_description }}">
    <meta name="twitter:image" content="{{ social_image }}">
    {% if twitter_handle %}
    <meta name="twitter:site" content="@{{ twitter_handle }}">
    <meta name="twitter:creator" content="@{{ twitter_handle }}">
    {% endif %}
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ social_url }}">
    
    <!-- Theme Toggle Script -->
    <script src="../../../static/theme-toggle.js"></script>
    
    <!-- Chapter Navigation Script -->
    <script>
        function jumpToChapter() {
            const select = document.getElementById('chapter-select');
            if (select.value) {
                window.location.href = select.value;
            }
        }
        
        // Reading settings functionality
        let currentTextSize = 100;
        let currentLineSpacing = 1.6;
        
        function loadReadingSettings() {
            const savedTextSize = localStorage.getItem('readingTextSize');
            const savedLineSpacing = localStorage.getItem('readingLineSpacing');
            
            if (savedTextSize) {
                currentTextSize = parseInt(savedTextSize);
                applyTextSize();
            }
            
            if (savedLineSpacing) {
                currentLineSpacing = parseFloat(savedLineSpacing);
                applyLineSpacing();
            }
            
            updateDisplays();
        }
        
        function adjustTextSize(delta) {
            currentTextSize = Math.max(70, Math.min(200, currentTextSize + (delta * 10)));
            applyTextSize();
            localStorage.setItem('readingTextSize', currentTextSize);
            updateDisplays();
        }
        
        function adjustLineSpacing(delta) {
            currentLineSpacing = Math.max(1.0, Math.min(3.0, currentLineSpacing + delta));
            applyLineSpacing();
            localStorage.setItem('readingLineSpacing', currentLineSpacing);
            updateDisplays();
        }
        
        function applyTextSize() {
            // Set CSS custom property on the root document for text size
            document.documentElement.style.setProperty('--reading-font-size', (currentTextSize / 100) + 'rem');
        }
        
        function applyLineSpacing() {
            // Set CSS custom property on the root document for line spacing
            document.documentElement.style.setProperty('--reading-line-height', currentLineSpacing);
        }
        
        function updateDisplays() {
            document.getElementById('text-size-display').textContent = currentTextSize + '%';
            document.getElementById('line-spacing-display').textContent = currentLineSpacing.toFixed(1);
        }
        
        function resetReadingSettings() {
            currentTextSize = 100;
            currentLineSpacing = 1.6;
            applyTextSize();
            applyLineSpacing();
            localStorage.removeItem('readingTextSize');
            localStorage.removeItem('readingLineSpacing');
            updateDisplays();
        }
        
        // Load settings when page loads
        document.addEventListener('DOMContentLoaded', loadReadingSettings);
    </script>
    
    {% if is_password_protected %}
    <script>
        // Password decryption functionality
        function sha256(str) {
            // Simple SHA256 implementation for client-side verification
            const msgBuffer = new TextEncoder().encode(str);
            return crypto.subtle.digest('SHA-256', msgBuffer).then(hashBuffer => {
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            });
        }

        function xorDecrypt(encryptedBase64, password) {
            // Recreate the SHA256 key from password
            return sha256(password).then(hashHex => {
                const key = new Uint8Array(hashHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                
                // Decode base64
                const encrypted = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
                
                // XOR decrypt
                const decrypted = new Uint8Array(encrypted.length);
                for (let i = 0; i < encrypted.length; i++) {
                    decrypted[i] = encrypted[i] ^ key[i % key.length];
                }
                
                // Convert back to string
                return new TextDecoder().decode(decrypted);
            });
        }

        function verifyPassword(password) {
            return sha256(password).then(hash => {
                return hash.substring(0, 16) === '{{ password_hash }}';
            });
        }

        function unlockContent() {
            const passwordInput = document.getElementById('password-input');
            const password = passwordInput.value;
            const errorMsg = document.getElementById('password-error');
            const loadingMsg = document.getElementById('password-loading');
            
            if (!password) {
                errorMsg.textContent = 'Please enter a password.';
                errorMsg.style.display = 'block';
                return;
            }
            
            errorMsg.style.display = 'none';
            loadingMsg.style.display = 'block';
            
            verifyPassword(password).then(isValid => {
                loadingMsg.style.display = 'none';
                
                if (isValid) {
                    xorDecrypt('{{ encrypted_content }}', password).then(decryptedContent => {
                        document.getElementById('chapter-content-wrapper').innerHTML = decryptedContent;
                        document.getElementById('password-protection-form').style.display = 'none';
                        
                        // Initialize Utterances comments if they exist in the decrypted content
                        if (typeof window.initializeUtterances === 'function') {
                            // Small delay to ensure DOM is updated
                            setTimeout(() => window.initializeUtterances(), 100);
                        }
                    });
                } else {
                    errorMsg.textContent = 'Invalid password. Please try again.';
                    errorMsg.style.display = 'block';
                }
            });
        }

        // Allow Enter key to unlock
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('password-input');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        unlockContent();
                    }
                });
            }
        });
    </script>
    {% endif %}
</head>
<body>
    <header>
        <nav class="breadcrumbs">
            <a href="../../../">Home</a>
            <span class="breadcrumb-separator">></span>
            <a href="../toc/">{{ novel.title }}</a>
            <span class="breadcrumb-separator">></span>
            <span class="current-page">{{ chapter_title }}</span>
        </nav>
        <nav class="chapter-nav">
            {% if prev_chapter %}
            <a href="../{{ prev_chapter.id }}/">Previous Chapter</a>
            {% endif %}
            <a href="../toc/">Table of Contents</a>
            {% if next_chapter %}
            <a href="../{{ next_chapter.id }}/">Next Chapter</a>
            {% endif %}
        </nav>
        
        <div class="chapter-dropdown">
            <label for="chapter-select">Jump to Chapter:</label>
            <select id="chapter-select" onchange="jumpToChapter()">
                <option value="">Select a chapter...</option>
                {% for arc in novel.arcs %}
                    <optgroup label="{{ arc.title }}">
                        {% for ch in arc.chapters %}
                            <option value="../{{ ch.id }}/" {% if ch.id == chapter.id %}selected{% endif %}>
                                {{ ch.title }}
                            </option>
                        {% endfor %}
                    </optgroup>
                {% endfor %}
            </select>
        </div>
        
        <div class="reading-config">
            <details>
                <summary>Reading Settings</summary>
                <div class="reading-controls">
                    <div class="control-group">
                        <label for="text-size">Text Size:</label>
                        <div class="button-group">
                            <button onclick="adjustTextSize(-1)">A-</button>
                            <span id="text-size-display">100%</span>
                            <button onclick="adjustTextSize(1)">A+</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="line-spacing">Line Spacing:</label>
                        <div class="button-group">
                            <button onclick="adjustLineSpacing(-0.1)">-</button>
                            <span id="line-spacing-display">1.6</span>
                            <button onclick="adjustLineSpacing(0.1)">+</button>
                        </div>
                    </div>
                    <button onclick="resetReadingSettings()" class="reset-button">Reset to Default</button>
                </div>
            </details>
        </div>
        {% if available_languages and available_languages|length > 1 %}
        <div class="language-switcher">
            <h3>Languages:</h3>
            {% for lang in available_languages %}
                {% if lang == current_language and not translation_missing %}
                    <span class="current-language">{{ lang|upper }}</span>
                {% else %}
                    <a href="../../{{ lang }}/{{ chapter.id }}/">{{ lang|upper }}</a>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
        <h1>{{ chapter_title }}</h1>
        
        {% if chapter_metadata and show_metadata %}
        <div class="chapter-metadata">
            {% if chapter_metadata.author %}
            <div class="metadata-item">
                <strong>Author:</strong> 
                {% set author_username = chapter_metadata.author | find_author_username(authors_config) %}
                {% if author_username %}
                <a href="../../../authors/{{ author_username }}/" class="metadata-author-link">{{ chapter_metadata.author }}</a>
                {% else %}
                {{ chapter_metadata.author }}
                {% endif %}
            </div>
            {% endif %}
            
            {% if chapter_metadata.translator %}
            <div class="metadata-item">
                <strong>Translator:</strong> 
                {% set translator_username = chapter_metadata.translator | find_author_username(authors_config) %}
                {% if translator_username %}
                <a href="../../../authors/{{ translator_username }}/" class="metadata-author-link">{{ chapter_metadata.translator }}</a>
                {% else %}
                {{ chapter_metadata.translator }}
                {% endif %}
            </div>
            {% endif %}
            
            {% if chapter_metadata.published %}
            <div class="metadata-item">
                <strong>Published:</strong> {{ chapter_metadata.published }}
            </div>
            {% endif %}
            
            {% if chapter_metadata.tags and show_tags %}
            <div class="metadata-item">
                <strong>Tags:</strong>
                <div class="tags">
                    {% for tag in chapter_metadata.tags %}
                    <a href="tags/{{ tag|slugify_tag }}/" class="tag">{{ tag }}</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if chapter_metadata.translation_notes and show_translation_notes %}
            <div class="metadata-item translation-notes">
                <strong>Translation Notes:</strong>
                <p>{{ chapter_metadata.translation_notes }}</p>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </header>
    <main>
        {% if translation_missing %}
        <div class="translation-notice">
            <p><strong>Translation Notice:</strong> This chapter is not yet available in {{ requested_language|upper }}. 
            You are viewing the {{ primary_language|upper }} version. 
            <a href="../{{ primary_language }}/{{ chapter.id }}.html">Continue reading in {{ primary_language|upper }}</a> or help contribute a translation!</p>
        </div>
        {% endif %}
        
        {% if is_password_protected %}
        <div id="password-protection-form" class="password-protection">
            <div class="password-form-container">
                <h3>ðŸ”’ Password Protected Content</h3>
                <p>{{ password_hint }}</p>
                
                <div class="password-input-group">
                    <input type="password" id="password-input" placeholder="Enter password" />
                    <button onclick="unlockContent()" class="unlock-button">Unlock</button>
                </div>
                
                <div id="password-loading" class="password-message" style="display: none;">
                    <p>ðŸ”“ Unlocking content...</p>
                </div>
                
                <div id="password-error" class="password-error" style="display: none;"></div>
                
                <div class="password-help">
                    <p><small>Having trouble? Make sure you have the correct password from your beta reader access or Patreon messages.</small></p>
                </div>
            </div>
        </div>
        {% endif %}
        
        <div id="chapter-content-wrapper" class="chapter-content">
            {{ chapter_content | safe }}
        </div>
        
        {% if chapter_metadata.translator_commentary %}
        <div class="translator-commentary">
            <h3>Translator's Commentary</h3>
            <div class="commentary-content">
                {{ chapter_metadata.translator_commentary | safe }}
            </div>
        </div>
        {% endif %}
        
        {% if comments_enabled and not is_password_protected %}
        <div class="comments-section">
            <h3>Comments</h3>
            <script src="https://utteranc.es/client.js"
                    repo="{{ comments_repo }}"
                    issue-term="{{ comments_issue_term }}"
                    label="{{ comments_label }}"
                    theme="{{ comments_theme }}"
                    crossorigin="anonymous"
                    async>
            </script>
        </div>
        {% endif %}
    </main>
    <footer>
        <nav>
            {% if prev_chapter %}
            <a href="../{{ prev_chapter.id }}/">Previous Chapter</a>
            {% endif %}
            <a href="../toc/">Table of Contents</a>
            {% if next_chapter %}
            <a href="../{{ next_chapter.id }}/">Next Chapter</a>
            {% endif %}
        </nav>
        <p>{{ footer_data.copyright }}</p>
        {% if footer_data.links %}
        <nav class="footer-links">
            {% for link in footer_data.links %}
            <a href="{{ link.url }}" target="_blank">{{ link.text }}</a>
            {% endfor %}
        </nav>
        {% endif %}
        {% if footer_data.additional_text %}
        <p class="footer-additional">{{ footer_data.additional_text }}</p>
        {% endif %}
    </footer>
</body>
</html>

